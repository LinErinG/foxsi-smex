Imaging
=======

To get started, remember to work in your foxsi-smex/idl directory and on startup run the script 

        IDL> @foxsi-smex-setup-script.pro

Main Functions:

>> foxsi_get_output_2d_image.pro    - for imaging at a single energy

>> foxsi_get_output_image_cube.pro  - for imaging at multiple energies.


foxsi_get_output_2d_image.pro                       (located in /response folder)
-------------------

>> Requires make_map and plot_map functions.

This function is intended to simulate the image measured by the FOXSI detectors for a
given input source image without spectral information.This must be a 2D monochromatic source.

This involves modelling the convolution of the image due to the point spread function of
the optics modules and the pixelisation of the detectors followed by accounting for counting
statistics by replacing each pixels value with a randomly selected value from a poisson 
distribution with a mean set by the original value of that pixel. The function may be run with an
automatically generated source (two narrow gaussians near the centre of a 150x150 FOV)
and a default pixelisation of 3'' per pixel with the call:

    IDL> rebinned_convolved_map = foxsi_get_2d_image()

And the output viewed with the command:

    IDL> plot_map, rebinned_convolved_map

Alternatively, a user supplied source_map may be supplied and the function run with a
custom pixelisation as follows:

    IDL> rebinned_convolved_map = foxsi_get_2d_image(source_map, px = "Your Pixelisation Value")

Note the source_map file contains information on the pixel size in arcseconds and the solar
coordinates of the centre of the field of view. This is automatically read in and propagated
in the programme.

The convolution currently only has one point spread function which was obtained from measuring
the point spread function for the on-axis position (<< note, currently off axis measurement used,
waiting for on axis fitting parameters >>) and fitting this with three gaussians. (See the preamble
of get_psf_array.pro for details). Future iterations of this code will include some functionality
to include variance in the psf for a given off axis source position and also for convolving at
different spatial points in the optics cross section.


WARNING: Run time is dependent on the size of the FOV. The default FOV is 150x150 pixels,
or 2.5'x2.5', this runs in a few seconds. Simulating the entire FOXSI FOV (~16.5'x16.5')
will take ~9 Hours.


Peripheral Functions:
- foxsi_get_source_map.pro                      (located in /response folder)
- foxsi_get_psf_array.pro                       (located in /response folder)



foxsi_get_output_image_cube.pro                       (located in /response folder)
-------------------

>> Requires make_map,plot_map, add_tag functions.

This function is intended to simulate the image measured by the FOXSI detectors for a
given input source with spectral information.

For each energy slice, each pixels flux (integrated in time) is multiplied by an effective area obtained from the function foxsi_get_effective_area and interpolated to match the energy value of the input source slice. This slice is then processed identically to the monochromatic case described above under foxsi_get_default_2d_image.pro.

The function may be called with a default spectral cube and default pixelisation ( 3'' per pixel). 

    IDL> rebinned_convolved_maps = foxsi_get_spectral_image()

The default cube is generated by the peripheral function foxsi_get_default_source_cube.pro. This is a stack of 100x100 flux maps with energies from 1.0 to 60.0 KeV with each slice 2.0 KeV apart. The sources present are two gaussians either side of the centre of the FOV. The left one has a constant energy profile while the other decays exponentially.

To run the code with your own source data, please provide:

  >> An array of 2d maps at evenly spaced energies (to be discussed)
  >> The energy value of the lower bound of the lowest energy bin of your data 
  >> The energy value of the upper bound of the highest energy bin of your data

Then run the code with the line

    IDL> rebinned_convolved_maps = get_foxsi_output_image_cube("your_source_cube",bin_min =   $
    'Lowest energy bound', bin_max = 'Highest energy bound', px = "Your Pixelisation Value")

The code then assigns each energy slice a corresponding upper and lower energy value assuming a constant bin size across the spectrum. This is done with the peripheral function foxsi_make_source_structure.pro and uses the add_tag function.

The output is an array of structures as above, each slice may be viewed with:

    IDL>  plot_map, rebinned_convolved_maps[i]

While the spectra for a given pixel (x,y) may be plotted against the midpoint energy of each bin with the line:

    IDL> plot, (rebinned_convolved_maps.bin_min + rebinned_convolved_maps.bin_max)/2, $ rebinned_convolved_maps.data[x,y,*]

Note: The convolution currently only has one point spread function which was obtained from measuring
the point spread function for the on-axis position (<< note, currently off axis measurement used,
waiting for on axis fitting parameters >>) and fitting this with three gaussians. (See the preamble
of get_psf_array.pro for details). Future iterations of this code will include some functionality
to include variance in the psf for a given off axis source position and also for convolving at
different spatial points in the optics cross section.


WARNING: Run time is dependent on the size of the FOV and number of spectral intervals. At testing, a grid of 100x100 pixels will be processed at ~0.5s per spectral slice.


Peripheral Functions:
- get_source_map.pro                      (located in /response folder)
- get_psf_array.pro                       (located in /response folder)
- foxsi_get_effective_area.pro            (located in /response folder)
- foxsi_make_source_structure.pro         (located in /response folder)
